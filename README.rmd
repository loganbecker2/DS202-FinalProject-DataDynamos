---
title: "DS 202 Final Project Data Dynamos"
author: "Members: Logan Becker, Gavin Herum, Jackson Weaver"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## View Data Set

```{r, message = FALSE}
#install.packages("readr")
library(readr)
# read datasets
injury_data <- read_csv("./injury_data.zip") 
player_data <- read_csv("./player_data.csv")
seasonsStats_data <- read_csv("./Seasons_Stats.csv")
head(injury_data)
head(player_data)
head(seasonsStats_data)
# These datasets are already cleaned we just need to filter it to the data we want
```

## Filter every dataset to be all years beyond (inclusive) 2010
```{r, message=FALSE}
# Filter injury_data
filtered_injurydata <- injury_data[as.numeric(format(injury_data$Date, "%Y")) >= 2010,]
print('injury_data')
summary(filtered_injurydata["Date"])

# Filter player_data
filtered_playerdata <- subset(player_data, year_start >= 2010 | year_end >= 2010)
print('player_data')
summary(filtered_playerdata[c("year_start", "year_end")])

# Filter seasons_stats
filtered_seasonsStatsdata <- subset(seasonsStats_data, Year >= 2010)
print('seasonsStats_data')
summary(filtered_seasonsStatsdata["Year"])
```

## Change old team names to their new team name
```{r, message=FALSE}
all_teams <- unique(filtered_injurydata$Team)
all_teams
# We see there is 32 teams here, there should only be 30 nba teams. Bullets and Bobcats are old names, let's change those to be correct
# Hornets <- Bobcats
# Wizards <- Bullets

filtered_injurydata$Team <- 
  ifelse(filtered_injurydata$Team == "Bobcats", "Hornets",
  ifelse(filtered_injurydata$Team == "Bullets", "Wizards",
         filtered_injurydata$Team))
# Check if there is now 30 teams
all_teams <- unique(filtered_injurydata$Team)
all_teams

# Checking teams for seasonsStats
all_teams2 <- unique(filtered_seasonsStatsdata$Tm)
#all_teams2
# 34 teams and when analyzing it further the data seems to be off in some of the teams for the players, so we probably will not use this
```

## Let's look at the highest injured teams
```{r, message=FALSE}
team_counts <- table(filtered_injurydata$Team)
sorted_team_counts <- sort(team_counts, decreasing = TRUE)
highest5_injuredTeams <- head(sorted_team_counts, 5)
highest5_injuredTeams
```
The most frequently injured team are Spurs (582), Celtics (530), Raptors (529), Mavericks (497), Heat (474).



## Lets find out the average duration of an injury

```{r, message = FALSE}

library(magrittr)
library(dplyr)
library(ggplot2)

# Create subset of the end of an injury
Acquired_subset <- subset(filtered_injurydata, is.na(filtered_injurydata$Relinquished))
Acquired_subset <- subset( Acquired_subset, select = -c(1, Relinquished) )

# Create subset of the begining of an injury
Relinquished_subset <- subset(filtered_injurydata, is.na(filtered_injurydata$Acquired))
Relinquished_subset <- subset( Relinquished_subset, select = -c(1, Acquired) )


# Merge the dataset with itself based on the player's name
merged_data <- merge(x = Acquired_subset, y = Relinquished_subset, by.x = "Acquired", by.y = "Relinquished", suffixes = c("_end", "_begin"))

merged_data$Date_gap <- as.numeric(difftime(merged_data$Date_end, merged_data$Date_begin, units = "days"))

# Removing all Date_gaps less than 0
merged_data <- subset(merged_data, Date_gap > 0 )

# Filtering to ensure no duplicate Date_end for a given Date_begin
injury_duration <- merged_data %>% 
  group_by(Acquired, Date_end)  %>% 
  filter(Date_gap == min(Date_gap))

# Reordering collumns of data
injury_duration <- injury_duration[, c("Acquired", "Date_begin", "Date_end", "Date_gap", "Team_begin", "Team_end", "Notes_begin", "Notes_end")]

# Rename column to Player
colnames(injury_duration)[colnames(injury_duration) == "Acquired"] <- 'Player'

Injury_duration_average <- mean(injury_duration$Date_gap)
Injury_duration_average

# This graph is messed up because Patty Mills had an injury that lasted for 2976 days
ggplot(injury_duration, aes(x = Date_gap)) +
  geom_bar(fill = "skyblue", color = "black") +
  labs(title = "Frequency of Different Injury Durations",
       x = "Duration of injury",
       y = "Frequency") +
  theme_minimal()

# This graph is a zoomed in version of only the injuries that lasted less than a year
ggplot(subset(injury_duration, Date_gap < 365 ), aes(x = Date_gap)) +
  geom_bar(fill = "skyblue", color = "black") +
  labs(title = 
  "Frequency of Different Injury Durations
  Excluding Injuries that Lasted more than a year (365 days)",
       x = "Duration of injury",
       y = "Frequency") +
  theme_minimal()
```

Based off of this data the average duration of an injury will be 13.85 days.



## Let's look at player age vs injury rates
```{r, message=FALSE}

# COULD PROBABLY BE OPTIMIZED BUT AM TIRED AND WILL DEAL WITH IT LATER; ALSO PROBABLY NOT THE MOST CLEAR CODE
# WILL ALSO CREATE SOME GRAPHS AND DIG DEEPER INTO IT

library(dplyr)
library(lubridate)
#change injurydata date column to just the year instead of date format to help merge
changed_injurydata <- filtered_injurydata
changed_injurydata$Date <- as.Date(changed_injurydata$Date)
changed_injurydata$Date <- year(changed_injurydata$Date)

# merge datasets and combine player info and injured player
ageVSinjury <- inner_join(changed_injurydata, filtered_seasonsStatsdata, 
                         by = c("Relinquished" = "Player", "Date" = "Year"),
                         relationship = "many-to-many")
# make sure there are no repeats
ageVSinjury <- distinct(ageVSinjury,...1.x, .keep_all = TRUE)
ageVSinjury

# make variable with all the ages for subsets
ageVSinjury_age <- ageVSinjury["Age"]
ageVSinjury_age
seasonStats_age <- filtered_seasonsStatsdata["Age"]
seasonStats_age

# First look at age range
age_range <- summary(filtered_seasonsStatsdata$Age)
age_range
# Age range is 19-40, lets split into groups by 3-4

# Split age range for injured players
age1 <- subset(ageVSinjury_age, Age <= 22)
age2 <- subset(ageVSinjury_age, Age <= 26 & Age > 22)
age3 <- subset(ageVSinjury_age, Age <= 30 & Age > 26)
age4 <- subset(ageVSinjury_age, Age <= 35 & Age > 30)
age5 <- subset(ageVSinjury_age, Age > 35)
# Split age range for all players
age11 <- subset(filtered_seasonsStatsdata, Age <= 22)
age22 <- subset(filtered_seasonsStatsdata, Age <= 26 & Age > 22)
age33 <- subset(filtered_seasonsStatsdata, Age <= 30 & Age > 26)
age44 <- subset(filtered_seasonsStatsdata, Age <= 35 & Age > 30)
age55 <- subset(filtered_seasonsStatsdata, Age > 35)

# Look at ratios of injured players vs all players for each age range
age1_ratio <- nrow(age1) / nrow(age11)
age2_ratio <- nrow(age2) / nrow(age22)
age3_ratio <- nrow(age3) / nrow(age33)
age4_ratio <- nrow(age4) / nrow(age44)
age5_ratio <- nrow(age5) / nrow(age55)
print(paste("19-22 years ratio:", nrow(age1) / nrow(age11)))
print(paste("23-26 years ratio:", nrow(age2) / nrow(age22)))
print(paste("27-30 years ratio:", nrow(age3) / nrow(age33)))
print(paste("31-35 years ratio:", nrow(age4) / nrow(age44)))
print(paste("36-40 years ratio:", nrow(age5) / nrow(age55)))
```











## may not be needed but here for testing purposes and to safe keep
```{r, message = FALSE}
# Filter injury data to only have rows where Relinquished is not NA (someone is injured)
library(dplyr)
filtered_injurydata <- filtered_injurydata %>%
  filter(!is.na(Relinquished))
# Deletes acquired row
#filtered_injurydata <- subset(filtered_injurydata, select = -Acquired)
summary(filtered_injurydata)


# Filter injury data to include only notes that contain "IL,IR,DTD" (injuries)
filtered_injurydata <- subset(filtered_injurydata, grepl("IL|IR|DTD", Notes))
print(filtered_injurydata)
```



```{r}

#combining data from injury_data and player_data, replacing values in Acquired column if NA shows up in Acquired column with Relinquished value in row. Then changing name to equal Acquired.

#We are making a column to merge by in the future

combining_data <- injury_data %>% select(Acquired, Relinquished, Notes) %>% mutate(Acquired = if_else(is.na(Relinquished), Acquired, Relinquished)) %>% mutate(name = Acquired) 


#made a new column with name to align with player_data, but no distinction among names, so same name will show up multiple times

#below will merge the two dataframes by name

merged_playerData_combiningData <- merge(player_data,combining_data, by = "name")

#count of injuries per player
counting_number_injuries <- combining_data %>% count(Acquired) #%>% as.numeric(n) 

ggplot(counting_number_injuries, aes(x = n)) +
  geom_histogram(binwidth = 1,) +
  labs(title = "Frequency of Injuries", x = "number of injuries", y = "Frequency")

#counts the number of injuries 
#counting_number_of_injuries <- counting_number_injuries %>% rename(number_of_injuries = n) %>% count(number_of_injuries) %>% rename(people_injured = number_of_injuries) %>% rename(count_of_injuries = n)

#print(counting_number_of_injuries)

merged_playerData_combiningData <- merge(player_data,combining_data, by = "name")




# shows number of injuries based on position
injuries_by_position <- merged_playerData_combiningData %>% count(position) %>% rename(number_of_injuries = n)

library(ggplot2)

#creates bar graph of injuries by position

ggplot(injuries_by_position, aes(x = position, y = number_of_injuries)) +
  geom_bar(stat = "identity") +
  labs(x = "Position Injuries", y = "Frequency", title = "Frequency of Injuries by Position")

##IL means they won't take up a bench spot
##IR means they'll be taking up a bench spot

##would certain positions get put on IL instead of IR because of position played?

library(stringr)
IL <- "placed on IL"
IR <- "placed on IR"

#below gives injuries that start with "placed on IL"

IL_position_injuries <- merged_playerData_combiningData %>% filter(str_starts(Notes, IL)) %>% select(position, Notes) %>% count(position) %>% rename(IL_injuries = n)

#below gives something that starts with IR and counts the position of each person

IR_position_injuries <- merged_playerData_combiningData %>% filter(str_starts(Notes, IR)) %>% select(position, Notes) %>% count(position) %>% rename(IR_injuries = n)
#print(IR_position_injuries)

#above from counting position for people placed on IR shows guard and forward are placed on it the most, could possibly be due to aggressiveness of position needed, however F-G, and Guard forward are the lowest

ggplot(IR_position_injuries, aes(x = position, y = IR_injuries)) +
  geom_bar(stat = "identity") +
  labs(x = "Position", y = "Frequency", title = "IR position injuries")

##how many IL happen per position, but by same position how many IR happens?

##IL means a more serious injury which could then impact that persons life. 
##Would they put someone on IL if they had a certain position compared to another position?

ggplot(IL_position_injuries, aes(x = position, y = IL_injuries)) +
  geom_bar(stat = "identity") +
  labs(x = "Position Injuries", y = "Frequency", title = "IL Position Injuries")


#merging IR and IL injuries in order to compare in bar graph
merging_IR_IL <- merge(IL_position_injuries, IR_position_injuries, by = "position")
#print(merging_IR_IL)


#bar graph below shows how much more likely you are to get put on IL when at that position.
#Doesn't account for type of injury, aggressiveness needed at said position and how they affect the team chemistry

ggplot(merging_IR_IL, aes(x = position, y = IL_injuries / IR_injuries)) +
  geom_bar(stat = "identity") +
  labs(x = "Position", y = "IL Injuries per IR Injuries", title = "IL to IR Injury constant Based on Position")


library(tidyr)


#below gets the number of players injured
injured_sample <- merged_playerData_combiningData %>% distinct(name) %>% nrow()

#below gets the total number of players
overall_sample_size <- player_data %>% distinct(name) %>% nrow()

#below gets the injury at least once per total players
print(injured_sample / overall_sample_size) * 100

#above shows we got a 46.5% chance a player will get injured at least once, while NLH says the amount injured at least once is a 46.8% chance
 

```


